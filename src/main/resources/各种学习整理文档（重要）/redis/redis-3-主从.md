Redis主从复制

```
1 新增redis6380.conf, 加入 slaveof ip port , 在6379启动完后再启6380，完成配置
2 redis-server --slaveof ip port
查看状态：info replication
断开主从复制 slaveof no one
断开后再变成主从复制 slaveof ip port
从节点建议用只读模式slave-read-only/replica-read-only=yes, 若从节点修改数据，主从数据不一致      
```

 注意项

```
传输延迟：
主从一般部署在不同机器上，复制时存在网络延时问题
redis提供repl-disable-tcp-nodelay参数决定是否关闭TCP_NODELAY,默认为关闭

参数关闭时：
	无论大小都会及时发布到从节点，占带宽，适用于主从网络好的场景
	
参数启用时：
	主节点合并所有数据成TCP包节省带宽，linux内核下, 默认为40毫秒发一次，适用于网络环境复杂或带宽紧张，如跨机房
```

拓扑结构

```
一主一从：
用于主节点故障转移从节点，当主节点的“写”命令并发高且需要持久化，可以只在从节点开启AOF（主节点不需要）

一主多从：
针对“读”较多的场景，“读”由多个从节点来分担，但节点越多，主节点同步到多节点的次数也越多，影响带宽，也加重主节点的稳定

树状主从：
一主多从的缺点（主节点推送次数多压力大）可用些方案解决，
主节点只推送一次数据到从节点1，再由从节点1推送到节点2，减轻主节点推送的压力
```

复制原理

```
1，保存主节点信息
2，主从建立socket连接
3，发送ping命令
4，权限验证
5，同步数据集
6，命令持续复制
```

数据同步

```
redis 2.8版本以上使用psync命令完成同步，过程分“全量”与“部分”复制
全量复制：
	一般用于初次复制场景（第一次建立SLAVE后全量）
部分复制：
	网络出现问题，从节点再次连主时，主节点补发缺少的数据，每次数据增加同步
心跳：
	从节点默认每10S向主节点发ping命令，
	配置项 repl-ping-slave-period/repl-ping-replica-period
```

主从故障转移

```
主从复制，若主节点出现问题，则不能提供服务，需要人工修改配置将从变主

主从复制主节点的写能力单机，能力有限

单机节点的存储能力也有限

主节点(master)故障，从节点slave-1端执行 slaveof no one后变成新主节点

其它的节点成为新主节点的从节点，并从新节点复制数据

需要人工干预，无法实现高可用
```

